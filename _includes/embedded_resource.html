{% comment %}
Embedded resource include for Google Slides and YouTube videos
Usage: {% include embedded_resource.html resource=resource preview_mode=true size='large' %}
{% endcomment %}

{% assign resource = include.resource %}
{% assign url = resource.url %}
{% assign title = resource.title %}
{% assign type = resource.type %}
{% assign preview_mode = include.preview_mode | default: false %}
{% assign size = include.size | default: 'normal' %}

{% comment %} Check if URL is Google Slides {% endcomment %}
{% assign is_google_slides = false %}
{% if url contains "docs.google.com/presentation/d/" %}
  {% assign is_google_slides = true %}
{% endif %}

{% comment %} Check if URL is YouTube {% endcomment %}
{% assign is_youtube = false %}
{% if url contains "youtube.com/watch?v=" or url contains "youtu.be/" or url contains "m.youtube.com/watch?v=" %}
  {% assign is_youtube = true %}
{% endif %}

{% if is_google_slides %}
  {% comment %} Extract presentation ID from Google Slides URL {% endcomment %}
  {% assign url_parts = url | split: "/d/" %}
  {% if url_parts.size > 1 %}
    {% assign id_with_path = url_parts[1] %}
    {% assign id_part = id_with_path | split: "/edit" | first | split: "/present" | first | split: "/pub" | first | split: "?" | first %}
    {% comment %} Handle both publication IDs (2PACX-*) and document IDs {% endcomment %}
    {% if id_part contains "2PACX-" %}
      {% comment %} Remove leading 'e/' from publication URLs {% endcomment %}
      {% assign clean_id = id_part | remove_first: "e/" %}
      {% if preview_mode %}
        {% assign embed_url = "https://docs.google.com/presentation/d/e/" | append: clean_id | append: "/embed?start=false&loop=false&delayms=3000&rm=minimal&chrome=false" %}
      {% else %}
        {% assign embed_url = "https://docs.google.com/presentation/d/e/" | append: clean_id | append: "/pubembed?start=false&loop=false&delayms=3000" %}
      {% endif %}
      {% assign thumb_url = "https://docs.google.com/presentation/d/e/" | append: clean_id | append: "/export/png" %}
    {% else %}
      {% comment %} For document IDs, try direct embed format first {% endcomment %}
      {% if preview_mode %}
        {% assign embed_url = "https://docs.google.com/presentation/d/" | append: id_part | append: "/embed?start=false&loop=false&delayms=3000&rm=minimal&chrome=false" %}
      {% else %}
        {% assign embed_url = "https://docs.google.com/presentation/d/" | append: id_part | append: "/embed?start=false&loop=false&delayms=3000" %}
      {% endif %}
      {% assign thumb_url = "https://docs.google.com/presentation/d/" | append: id_part | append: "/export/png" %}
    {% endif %}
    
    {% if preview_mode %}
      <div class="preview-thumbnail preview-{{ size }}">
        {% if include.talk_url %}
        <a href="{{ include.talk_url }}" class="preview-link">
          <div class="slides-embed-preview">
            <iframe src="{{ embed_url }}" 
                    frameborder="0" 
                    allowfullscreen
                    loading="lazy"
                    title="{{ title | escape }}"
                    class="preview-iframe slides-preview"
                    sandbox="allow-scripts allow-same-origin allow-presentation">
            </iframe>
          </div>
        </a>
        {% else %}
        <div class="slides-embed-preview">
          <iframe src="{{ embed_url }}" 
                  frameborder="0" 
                  allowfullscreen
                  loading="lazy"
                  title="{{ title | escape }}"
                  class="preview-iframe slides-preview"
                  sandbox="allow-scripts allow-same-origin allow-presentation">
          </iframe>
        </div>
        {% endif %}
      </div>
    {% else %}
      <div class="embed-container slides-embed">
        <iframe src="{{ embed_url }}" 
                frameborder="0" 
                allowfullscreen
                loading="lazy"
                title="{{ title | escape }}"
                class="responsive-iframe"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                referrerpolicy="strict-origin-when-cross-origin"
                sandbox="allow-scripts allow-same-origin allow-presentation">
        </iframe>
      </div>
    {% endif %}
  {% else %}
    {% comment %} Fallback to link if URL parsing fails {% endcomment %}
    {% if not preview_mode %}
      <div class="resource-fallback">
        <a href="{{ url }}" target="_blank" rel="noopener noreferrer" class="resource-link">
          {{ title }}
          {% if include.resource.description %}<span class="resource-description">{{ include.resource.description }}</span>{% endif %}
        </a>
      </div>
    {% endif %}
  {% endif %}

{% elsif is_youtube %}
  {% comment %} Extract video ID from YouTube URL {% endcomment %}
  {% assign video_id = "" %}
  
  {% if url contains "youtube.com/watch?v=" or url contains "m.youtube.com/watch?v=" %}
    {% comment %} Extract from youtube.com/watch?v=ID format {% endcomment %}
    {% assign url_parts = url | split: "v=" %}
    {% if url_parts.size > 1 %}
      {% assign video_id = url_parts[1] | split: "&" | first %}
    {% endif %}
  {% elsif url contains "youtu.be/" %}
    {% comment %} Extract from youtu.be/ID format {% endcomment %}
    {% assign url_parts = url | split: "youtu.be/" %}
    {% if url_parts.size > 1 %}
      {% assign video_id = url_parts[1] | split: "?" | first | split: "&" | first %}
    {% endif %}
  {% endif %}
  
  {% if video_id != "" %}
    {% assign embed_url = "https://www.youtube-nocookie.com/embed/" | append: video_id %}
    
    {% if preview_mode %}
      <div class="preview-thumbnail preview-{{ size }}">
        <img src="https://img.youtube.com/vi/{{ video_id }}/maxresdefault.jpg" 
             alt="{{ title | escape }}" 
             class="preview-image">
        <div class="play-overlay">
          <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5v14l11-7z"/>
          </svg>
        </div>
      </div>
    {% else %}
      <div class="embed-container video-embed">
        <iframe src="{{ embed_url }}" 
                frameborder="0"
                allowfullscreen
                loading="lazy"
                title="{{ title | escape }}"
                class="responsive-iframe"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                referrerpolicy="strict-origin-when-cross-origin"
                sandbox="allow-scripts allow-same-origin allow-presentation">
        </iframe>
      </div>
    {% endif %}
  {% else %}
    {% comment %} Fallback to link if video ID extraction fails {% endcomment %}
    {% if not preview_mode %}
      <div class="resource-fallback">
        <a href="{{ url }}" target="_blank" rel="noopener noreferrer" class="resource-link">
          {{ title }}
          {% if include.resource.description %}<span class="resource-description">{{ include.resource.description }}</span>{% endif %}
        </a>
      </div>
    {% endif %}
  {% endif %}

{% else %}
  {% comment %} Non-embeddable URL - show as regular link {% endcomment %}
  <div class="resource-fallback">
    <a href="{{ url }}" target="_blank" rel="noopener noreferrer" class="resource-link">
      {{ title }}
      {% if include.resource.description %}<span class="resource-description">{{ include.resource.description }}</span>{% endif %}
    </a>
  </div>
{% endif %}